# Epic 4 Retrospective – Interaction & Workflow Efficiency

**Epic:** 4  
**Epic Title:** Interaction & Workflow Efficiency  
**Date:** 2026-01-07  
**Participants:** Stefano (Developer / Project Lead), Bob (Scrum Master, AI assistant)

---

## 1. Epic Overview

Epic 4 delivered the "keyboard-first" operation promise from the PRD: a detailed signal preview, smooth keyboard navigation, one-key copy-and-advance workflow, and structured error surfacing that gives users actionable guidance instead of cryptic failures.

- **4.1 – Signal Preview Pane:** Full formatted payload display with monospace font, creating `formatSignalPayload` as the canonical signal text source.
- **4.2 – Keyboard Navigation:** Arrow Up/Down navigation with ARIA listbox semantics, visual highlighting, and selection state management.
- **4.3 – Copy & Advance Workflow:** Enter key or button copies signal to clipboard, marks row as processed with ✓ badge, and advances selection to next unprocessed row.
- **4.4 – Structured Error Surfacing:** Three-tier error display (InlineError, ErrorBanner, SystemErrorBar) with discriminated union pattern and centralized error store.

Epic status: **Complete** (Stories 4.1–4.4 done; retrospective recorded).

---

## 2. What Went Well

1. **Keyboard-first promise delivered**
   - Arrow navigation, Enter to copy, visual feedback, and processed-row tracking all compose into a smooth, high-speed workflow.

2. **Excellent test coverage (156 tests)**
   - Story 4.1: 37 tests, 4.2: 35 tests, 4.3: 46 tests, 4.4: 38 tests
   - Tests cover edge cases like empty feeds, stale data, rapid key presses, and error state transitions.

3. **Adversarial code review caught 8 issues**
   - 4.4's review identified: unused ErrorBanner, missing TRPC stub, wrong aria-live value, dynamic import smell, mock tests instead of real imports, incomplete IpcResult usage.
   - All issues fixed before marking story done.

4. **Architecture reuse from earlier epics**
   - Signal Preview reuses `ArbitrageOpportunity` model from Epic 2.
   - Keyboard navigation builds on Epic 3's virtualized feed and selection patterns.
   - Error surfacing leverages Epic 2's logging infrastructure and Epic 3's status indicators.

5. **Single source of truth patterns**
   - `formatSignalPayload` is the canonical signal text (4.1), reused by Copy & Advance (4.3).
   - `dashboardErrorStore` centralizes all error state without ad-hoc boolean flags.

---

## 3. What Was Challenging

1. **Story 4.4 complexity**
   - Touched 15 files across main, renderer, and shared layers.
   - Discriminated union pattern (`IpcResult<T>`) required discipline across TRPC routes, error mappers, and UI components.

2. **Circular dependency concerns**
   - feedStore.ts initially used dynamic import to avoid circular dependency with dashboardErrorStore.
   - Fixed during code review by restructuring imports (no actual cycle existed).

3. **Component integration gaps**
   - ErrorBanner was fully implemented but never wired into DashboardLayout until code review.
   - Lesson: integrate components immediately after creation, not as a separate step.

4. **Context file process gap**
   - Story 4.4 skipped the `ready-for-dev` step that creates context XML.
   - Retroactively created during code review; need to follow process consistently.

5. **Mock test fragility**
   - Original 4.4 tests used duplicate mock logic instead of importing real functions.
   - Tests passed even when implementation was broken; fixed by importing from compiled output.

---

## 4. Key Lessons Learned

1. **Adversarial code reviews are essential for complex stories**
   - Normal implementation flow missed 8 issues that adversarial review caught.
   - Consider mandatory adversarial reviews for stories touching 10+ files.

2. **Real function tests > mock logic tests**
   - Tests should import actual implementation from compiled output.
   - Duplicate mock logic creates false confidence when implementation diverges.

3. **Discriminated union pattern pays off**
   - `IpcResult<T>` provides compile-time safety for error handling.
   - Requires consistent adoption across all TRPC procedures and call sites.

4. **Wire components immediately**
   - Creating a component without integrating it leaves gaps that code review must catch.
   - Integration should be part of the same commit as component creation.

5. **Follow the story workflow completely**
   - Skipping `ready-for-dev` step skipped context XML creation.
   - All workflow steps exist for a reason; don't shortcut the process.

---

## 5. Epic 3 Action Item Follow-Through

| Action Item | Status | Evidence |
|------------|--------|----------|
| **E3-AI-01** Centralize dashboard semantics | ✅ Completed | `dashboardErrorStore` is single source of truth for errors |
| **E3-AI-02** Harden league/region/market mapping | ⏳ Deferred | Not addressed in Epic 4; relevant for Epic 5 multi-provider work |
| **E3-AI-03** Monitor dashboard performance | ✅ Completed | Keyboard nav works smoothly with virtualized feed |
| **E3-AI-04** Align provider status with user expectations | ✅ Completed | ErrorBanner shows provider errors with clear guidance |
| **E3-AI-05** Reuse Epic 3 patterns | ✅ Completed | All stories built on existing dashboard architecture |

---

## 6. Action Items

**E4-AI-01 – Mandate adversarial reviews for complex stories**
- **Description:** Stories touching 10+ files should require adversarial code review before marking `done`.
- **Owner:** Stefano
- **When to apply:** All future epics.

**E4-AI-02 – Import real functions in tests**
- **Description:** Tests should import actual implementation from compiled output, not duplicate mock logic.
- **Owner:** Stefano
- **When to apply:** Immediately; audit existing test files.

**E4-AI-03 – Integrate components immediately**
- **Description:** Component creation and integration into parent should be part of the same task/commit.
- **Owner:** Stefano
- **When to apply:** All future UI stories.

**E4-AI-04 – Complete story workflow without shortcuts**
- **Description:** Follow all workflow steps (including `ready-for-dev` and context XML creation) for every story.
- **Owner:** Stefano
- **When to apply:** All future stories.

**E4-AI-05 – Address E3-AI-02 in Epic 5**
- **Description:** League/region/market mapping hardening was deferred from Epic 3; address during Epic 5 multi-provider work.
- **Owner:** Stefano
- **When to apply:** Epic 5 Story 5.1 or 5.2.

---

## 7. Next Epic Preparation (Epic 5 – Multi-Provider & Advanced Markets)

- **Focus:** Broaden bookmaker coverage by enabling multiple data providers simultaneously, merge feeds into unified view, and expand market type support.
- **Dependencies from Epic 4:**
  - Error surfacing patterns (InlineError, ErrorBanner, SystemErrorBar) ready for multi-provider scenarios.
  - `IpcResult<T>` pattern established for all TRPC communication.
  - Keyboard navigation and copy workflow work with any feed content.
- **Key Risks for Epic 5:**
  - **Rate limiting across multiple providers** – Must respect per-provider quotas simultaneously.
  - **Deduplication of opportunities** – Same event from multiple providers needs proper merge logic.
  - **Market type normalization** – Different providers use different naming for same markets.
- **Readiness Check:**
  - All Epic 4 stories (4.1–4.4) are **done** with 156 passing tests.
  - Error surfacing infrastructure ready for multi-provider error scenarios.
  - E3-AI-02 (league/region mapping) should be addressed early in Epic 5.

---

## 8. Summary

Epic 4 successfully delivered the keyboard-first interaction layer:

- **Signal Preview:** Canonical formatted payload for clipboard operations
- **Keyboard Navigation:** Smooth Arrow/Enter workflow with accessibility
- **Copy & Advance:** One-key operation with processed-row tracking
- **Error Surfacing:** Three-tier display with discriminated union pattern

The adversarial code review on Story 4.4 proved its value by catching 8 issues. Future complex stories should mandate this approach.

**Bob (Scrum Master):** "Epic 4 gave you the 'hands' of the arbitrage workflow – users can now navigate, copy, and process opportunities at high speed while understanding exactly what's happening when things go wrong. Epic 5 will expand the brain with multi-provider support, building on the solid interaction patterns you've established."

---

_Retrospective recorded: 2026-01-07_
