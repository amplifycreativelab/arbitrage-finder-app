<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3</storyId>
    <title>Visual Staleness Logic</title>
    <status>drafted</status>
    <generatedAt>2025-11-21</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>_bmad-output/implementation-artifacts/3-3-visual-staleness-logic.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>User</asA>
    <iWant>to recognize when data is old in the feed</iWant>
    <soThat>I do not act on stale opportunities</soThat>
    <tasks>
      Implement staleness computation based on opportunity timestamps; apply staleness visuals to the feed grid; add a timer-driven staleness update loop in the dashboard; and add tests for staleness behavior across labels, opacity, and timer updates.
    </tasks>
  </story>

  <acceptanceCriteria>
    Items older than 5 minutes are visually de-emphasized in the feed while preserving readability; each row shows a human-readable "time since last update" label computed from a timestamp; a lightweight client timer recomputes staleness every ~30 seconds without triggering new API calls; visuals compose correctly with existing feed behaviors and remain accessible; and tests assert labeling, opacity thresholds, and timer-driven updates without extra network activity.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      _bmad-output/prd.md (FR13 Staleness Indicator and "Staleness Visibility" requirements);
      _bmad-output/architecture.md (Error Handling, Logging, and Observability; UX Error and Degraded States);
      _bmad-output/ux-design-specification.md (Hybrid Dashboard layout, Orange Terminal theme, and staleness indicator UX);
      _bmad-output/epics.md (Epic 3, Story 3.3 - Visual Staleness Logic);
      _bmad-output/implementation-artifacts/3-1-main-layout-split-pane.md (dashboard layout and split-pane shell);
      _bmad-output/implementation-artifacts/3-2-feed-left-pane-data-grid.md (feed grid behavior, sorting, and virtualization).
    </docs>
    <code>
      src/main/services/poller.ts (polling, freshness timestamps, and system status including stale detection);
      src/renderer/src/features/dashboard/stores/feedStore.ts (feed snapshot state, including fetchedAt timestamps and snapshot refresh behavior);
      src/renderer/src/features/dashboard/FeedTable.tsx (feed row rendering, time and ROI columns, and virtualization strategy);
      src/renderer/src/features/dashboard/FeedPane.tsx (feed loading/error states and snapshot refresh wiring);
      src/renderer/src/lib/trpc.ts (typed bridge for feed snapshot retrieval from the main process);
      shared/types.ts and shared/schemas.ts (ArbitrageOpportunity shape, including event date and potential timestamp fields).
    </code>
    <dependencies>
      package.json (React, Zustand, date-fns, and related UI dependencies used in the feed and dashboard);
      electron, electron-trpc, and supporting libraries that underpin polling and renderer-main communication.
    </dependencies>
  </artifacts>

  <constraints>
    Respect the Orange Terminal theme and accessibility requirements when dimming stale rows; avoid introducing new ad-hoc staleness flags when existing timestamps and heartbeat data can be reused; ensure that staleness logic does not trigger extra API requests and remains purely client-driven; and preserve existing split-pane layout, virtualization, and keyboard navigation behavior from Stories 3.1 and 3.2.
  </constraints>

  <interfaces>
    Feed snapshot retrieval via trpcClient.pollAndGetFeedSnapshot in src/renderer/src/lib/trpc.ts, returning opportunities and fetchedAt metadata; and main-process snapshot access via getLatestSnapshotForProvider in src/main/services/poller.ts, which exposes opportunities plus a fetchedAt ISO timestamp per provider.
  </interfaces>

  <tests>
    <standards>
      Follow existing Epic 3 dashboard testing patterns using component/integration tests that render the feed at representative desktop widths; use fake timers where appropriate; and assert behavior via stable data-testid attributes without depending on internal implementation details.
    </standards>
    <locations>
      tests/3.2-feed-left-pane-data-grid.test.cjs for existing feed behavior coverage; and a new Epic 3 test file such as tests/3.3-visual-staleness-logic.test.cjs or renderer/src/features/dashboard/__tests__/3-3-visual-staleness-logic.test.tsx for staleness-specific tests.
    </locations>
    <ideas>
      Test that rows older than 5 minutes are rendered with reduced opacity and appropriate staleness labels; verify that rows younger than the threshold remain fully emphasized; assert that advancing fake timers updates labels and visuals without additional network calls; and ensure that selection, sorting, and virtualization continue to work correctly with staleness styling applied.
    </ideas>
  </tests>
</story-context>

